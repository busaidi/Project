<!-- templates/network/map.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Network Map</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css">
    <style>
        .map {
            height: 100vh;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="map" class="map"></div>
    <script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>
    <script>
        console.log('Initializing map...');

        // Initialize map
        var map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([58.3894, 23.6143]), // Center on Oman
                zoom: 7
            })
        });

        console.log('Map initialized.');

        // Function to add layer
        function addLayer(url, color) {
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log('Data fetched:', data);

                    if (data.features && data.features.length > 0) {
                        var vectorSource = new ol.source.Vector({
                            features: new ol.format.GeoJSON().readFeatures(data, {
                                dataProjection: 'EPSG:4326',
                                featureProjection: 'EPSG:3857'
                            })
                        });

                        var vectorLayer = new ol.layer.Vector({
                            source: vectorSource,
                            style: new ol.style.Style({
                                stroke: new ol.style.Stroke({
                                    color: color,
                                    width: 2
                                })
                            })
                        });

                        map.addLayer(vectorLayer);
                        map.getView().fit(vectorSource.getExtent(), { size: map.getSize(), maxZoom: 15 });
                        console.log('Layer added to map.');
                    } else {
                        console.log('No features found in the data.');
                    }
                })
                .catch(error => console.log('Error:', error));
        }

        // Add layers
        addLayer('/api/tracks/', 'red');
        addLayer('/api/ducts/', 'green');
        addLayer('/api/subducts/', 'blue');
        addLayer('/api/cables/', 'orange');

        // Add interactivity
        map.on('singleclick', function (evt) {
            var coordinate = evt.coordinate;
            var viewResolution = map.getView().getResolution();
            var url = vectorLayer.getSource().getFeatureInfoUrl(
                evt.coordinate, viewResolution, 'EPSG:3857',
                {'INFO_FORMAT': 'application/json'}
            );

            if (url) {
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Feature Info:', data);
                        if (data.features.length > 0) {
                            var feature = data.features[0];
                            var info = '<h3>' + feature.properties.name + '</h3>';
                            document.getElementById('info').innerHTML = info;
                        }
                    });
            }
        });
    </script>
</body>
</html>
